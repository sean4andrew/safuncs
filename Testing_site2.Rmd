---
title: "Testing Grounds"
output: 
  rmdformats::readthedown:
    code_download: true
date: '`r format(Sys.time(), "%d %B, %Y")`'
---

# Heading 1

```{r}
remotes::install_github("sean4andrew/safuncs")
use_package() 
```


```{r}
Surv_Gen(mort_db = mort_db_ex,
         last_tte = 54,
         starting_fish_count = 100)
```


Label generator (script)
```{r, warning = FALSE}
study_id = "ONDA01180"
timepoint = "Baseline"
trt_tank_id = c("Tk.F01-TrtA", "Tk.F02-TrtA", "Tk.F03-TrtB", "Tk.F04-TrtB")
animal = "Fish"
animal_numbers = 1:4
tissue = c("Spleen", "Liver")
replic = NA
n_col = 6

# Formatting (don't mind me):
replic = paste("Rep", replic, sep = "")

# Actually important stuff (edit me!)
combin = levels(interaction(study_id, timepoint, trt_tank_id, animal, animal_numbers, tissue, sep = ", ", lex.order = TRUE))

# Resolving printout issues (don't mind me)
mat = matrix(c(combin, rep("", (ceiling(length(combin)/n_col) * n_col) - length(combin))), ncol = n_col)

# Print outputs (don't mind me)
View(mat)
paste("Your total label count is:", length(combin))
write.csv(x = mat, file = paste(study_id, "labels.csv", sep = " "))
```

Label generator function demo:
```{r}
Label_Gen(study_id = "ONDA01180",
          timepoint = "Baseline",
          trt_tank_id = c("Tk.F01-TrtA", "Tk.F02-TrtA", "Tk.F03-TrtB", "Tk.F04-TrtB"),
          animal = "Fish",
          animal_numbers = 1:4,
          tissue = c("Spleen", "Liver"),
          repli_num = NA,
          n_col = 4) # number of columns in label paper

#Also, don't forget to demo what to do if you don't have information for a column (put "NA")
```

Label generator function
```{r}
Label_Gen = function(study_id,
                     timepoint,
                     trt_tank_id,
                     animal,
                     animal_numbers,
                     tissue,
                     repli_num,
                     n_col) {
  
  # formatting variables
  if(!is.na(repli_num)[1]){repli_num <<- paste("Rep", repli_num, sep = "")}
  if(!is.na(animal[1]) & !is.na(animal_numbers[1])){
    animal <<- levels(interaction(animal, animal_numbers, sep = "-", lex.order = TRUE))
    animal_numbers <<- NA
  }

  # remove NA variables from combination
  v_vec = c("study_id", "timepoint", "trt_tank_id", "animal", "animal_numbers", "tissue", "repli_num")
  nonNA_vec = v_vec[!is.na(sapply(v_vec, get))]
  
  # get combination
  get_vec = sapply(nonNA_vec, get)
  combin = levels(interaction(sapply(nonNA_vec, get), sep = ", ", lex.order = TRUE))
  mat = matrix(c(combin, rep("", (ceiling(length(combin)/n_col) * n_col) - length(combin))), ncol = n_col)
  
  # print outputs for double verification purposes
  View(mat)
  print(paste("Your total label count is:", length(combin)))

  # save output
  if(is.na(timepoint)) {
    write.csv(x = mat, file = paste(study_id, "labels.csv", sep = " "))
  } else {
    write.csv(x = mat, file = paste(study_id, timepoint, "labels.csv", sep = " "))
  }
}
```




Test
```{r}
haz_db = haz_db_ex
fish_num_per_tank = 100
tank_num_per_trt = 4
treatments_hr = c(1, 0.8, 0.5)
logHR_sd_intertank = 0
sampling_specs = NULL
n_sim = 10
plot_out = TRUE
pop_out = TRUE
plot_name = "Surv_Simul-Plot-Output"
theme = "ggplot2"

  #Initialize objects to store loop results
  surv_samps = data.frame()
  cens_db = data.frame()
  Surv_simul_outDB = data.frame()
  pvalues = c()
  colnames(haz_db) = tolower(colnames(haz_db))

  #Simulate survival dataframe
  for(loopnum in 1:n_sim) {

    CDF_Yval = c()

    for(Treatment_Term in treatments_hr) {

      for(Tank_num in 1:tank_num_per_trt) {

        #Random sampling
        Tank_eff = rnorm(n = 1, mean = 0, sd = logHR_sd_intertank)

        U = runif(n = fish_num_per_tank, min = 0, max = 1)

        CDF_Yval_temp = -log(U) * exp(-(log(Treatment_Term) + Tank_eff))
        CDF_Yval = append(CDF_Yval, CDF_Yval_temp)
      }
    }

    #Get Time to Event
    TTE = approx(x = cumsum(haz_db$hazard), y = haz_db$time, xout = CDF_Yval, method = "linear")$y
    TTE = round(TTE, digits = 0)

    #Turn NA (from out of bound CDF_Yval) to the last follow up time
    TTE = ifelse(is.na(TTE), max(haz_db$time), TTE)

    #Label Status (1 - dead, or 0 - survived) given TTE, and create survival dataframe
    Surv_simul_DB = data.frame(TTE = TTE,
                               Status = ifelse(TTE == max(haz_db$time), 0, 1),
                               Trt.ID = as.factor(rep(c("Control", LETTERS[2:length(treatments_hr)]),
                                                      each = fish_num_per_tank * tank_num_per_trt, times = n_sim)),
                               Tank.ID = as.factor(rep(1:(length(treatments_hr) * tank_num_per_trt),
                                                       each = fish_num_per_tank, times = n_sim)),
                               n_sim = loopnum)

    #Transform TTE and Status in certain rows due to sampling
    if(!is.null(sampling_specs)) {

      #Repeat for each specified sampling time and each tank
      for(samp_time in 1:length(sampling_specs$TTE)) {
        for(tank_num in as.numeric(levels(Surv_simul_DB$Tank.ID))) {

          rows_sel = sample(x = which(Surv_simul_DB$Tank.ID == tank_num & Surv_simul_DB$TTE > sampling_specs$TTE[samp_time]),
                            size = sampling_specs$Amount[samp_time],
                            replace = FALSE)

          Surv_simul_DB$TTE[rows_sel] = sampling_specs$TTE[samp_time]
          Surv_simul_DB$Status[rows_sel] = 0
        }
      }
    }

    #Get p-value for plots
    pvalues = append(pvalues, survival::survdiff(survival::Surv(TTE, Status) ~ Trt.ID, Surv_simul_DB)$pvalue)

    #Simulated survival data to be provided as output
    Surv_simul_outDB = rbind(Surv_simul_outDB, Surv_simul_DB)

    #Transform simulated survival data for plotting purposes
    surv_obj = survival::survfit(survival::Surv(TTE, Status) ~ Trt.ID, data = Surv_simul_DB)
    if(length(levels(as.factor(Surv_simul_DB$Trt.ID))) > 1) {
      attributes(surv_obj$strata)$names <- levels(as.factor(Surv_simul_DB$Trt.ID))
    } else {
      surv_obj$strata = length(surv_obj$surv)
      attributes(surv_obj$strata)$names <- levels(as.factor(Surv_simul_DB$Trt.ID))
    }

    surv_samps_temp = data.frame(Trt.ID = summary(surv_obj)$strata,
                                 surv_prob = summary(surv_obj)$surv,
                                 time = summary(surv_obj)$time,
                                 type = paste("Sample (n = ", n_sim, ")", sep = ""),
                                 n_sim = loopnum,
                                 alpha = 1 - (0.0001 ^ (1/n_sim)))

    surv_samps_ends = data.frame(surv_samps_temp %>%
                                   dplyr::group_by(Trt.ID) %>%
                                   dplyr::reframe(surv_prob = c(1, min(surv_prob)),
                                                  time = c(floor(min(haz_db$time)), ceiling(max(haz_db$time))),
                                                  n_sim = loopnum,
                                                  alpha = 1 - (0.0001 ^ (1/n_sim))))
    surv_samps_ends$type = paste("Sample (n = ", n_sim, ")", sep = "")

    surv_samps = rbind(surv_samps, surv_samps_temp, surv_samps_ends)

    if(!is.null(sampling_specs)){
      #Get survival probability at mid censoring
      cens_db_temp  = data.frame(Trt.ID = summary(surv_obj, time = sampling_specs$TTE)$strata,
                                 surv_prob = summary(surv_obj, time = sampling_specs$TTE)$surv,
                                 time = summary(surv_obj, time = sampling_specs$TTE)$time,
                                 n_sim = loopnum,
                                 type = as.factor(paste("Sample (n = ", n_sim, ")", sep = "")))
      cens_db = rbind(cens_db, cens_db_temp)
    }
  }

  #Get "population" survival dataset by exponentiating the negative cumulative hazard
  pop_haz_db = data.frame(approx(x = haz_db$time, y = haz_db$hazard, xout = seq(min(haz_db$time), max(haz_db$time), 0.1), method = "linear"))
  colnames(pop_haz_db) = c("time", "hazard")

  
  #For use with old surv_prob method (deprecated)
  surv_pop = data.frame(Trt.ID = as.factor(rep(c("Control", LETTERS[2:length(treatments_hr)]), each = length(haz_db$hazard))),
                        #cumhaz_prob = as.vector(apply((haz_db$hazard) %*% t(treatments_hr), 2, cumsum)),
                        surv_prob = exp(-as.vector(apply(haz_db$hazard %*% t(treatments_hr), 2, cumsum))),
                        time = rep(haz_db$time, times = length(treatments_hr)),
                        type = "Population / truth",
                        n_sim = 1,
                        alpha = 1)
  #methods to get surv_prob stored here below:
  #option 1 (old):
  #surv_prob = exp(-as.vector(apply(haz_db$hazard %*% t(treatments_hr), 2, cumsum)))
  
  # #New method
  # surv_pop = data.frame()
  # for(pop_trt in levels(factor(surv_pop_old$Trt.ID))) {
  #   pop_trt_cumhaz = surv_pop_old$cumhaz_prob[surv_pop_old$Trt.ID == pop_trt]
  #   surv_prob_db = approx(x = haz_db$time, y = pop_trt_cumhaz, xout = seq(min(haz_db$time), max(haz_db$time), 0.1), method = "linear")
  #   
  #   surv_pop_temp = data.frame(Trt.ID = pop_trt,
  #                              time = surv_prob_db$x,
  #                              surv_prob = exp(-surv_prob_db$y),
  #                              type = "Population / truth",
  #                              n_sim = 1,
  #                              alpha = 1)
  #   surv_pop = rbind(surv_pop, surv_pop_temp)
  # }

  #To the end of creating survival plots
  surv_comb = rbind(surv_samps, surv_pop)
  surv_comb$type = factor(surv_comb$type, levels = c(paste("Sample (n = ", n_sim, ")", sep = ""), "Population / truth"))
  surv_comb$Trt.ID = factor(surv_comb$Trt.ID, levels = rep(c("Control", LETTERS[2:length(treatments_hr)])))

  #Get end_sr for population plots and sample plots
  end_db = data.frame(surv_comb %>%
                        dplyr::group_by(type, Trt.ID, n_sim) %>%
                        dplyr::summarise(surv_prob = min(surv_prob), time = max(TTE), .groups = "drop") %>%
                        dplyr::group_by(type, Trt.ID) %>%
                        dplyr::summarise(surv_prob = mean(surv_prob), time = max(time), .groups = "drop"))

  #Get % significance (i.e. power) for plotting
  perc_sf = paste(round(100 * sum(pvalues < 0.05) / length(pvalues), digits = 0), "%", sep = "")

  #Ggplot
  surv_plots = ggplot(data = surv_comb, aes(x = time, y = surv_prob, colour = Trt.ID, group = interaction(n_sim, Trt.ID))) +
    facet_wrap(~ type) +
    geom_step(aes(alpha = alpha)) +
    scale_y_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1), labels = scales::percent) +
    scale_x_continuous(breaks = seq(0, max(surv_pop$time), max(round(max(surv_pop$time) / 15), 1))) +
    ylab("Survival Probability (%)") +
    xlab("Time to Event") +
    scale_alpha(range = c(min(surv_comb$alpha), 1))+
    guides(alpha = "none") +
    coord_cartesian(clip = "off") +
    theme(plot.margin = margin(5.5, 20, 5.5, 5.5))

  if(n_sim == 1) {
    surv_plots = surv_plots +
      geom_text(data = end_db, aes(x = time, y = surv_prob, label = round(surv_prob * 100, digits = 0)),
                vjust = -0.3, hjust = 0.8, show.legend = FALSE, size = 3.3) +
      annotation_custom(grob = grid::textGrob(paste(c(paste("The sample has a", sep = ""),
                                                      paste("p-value = ", signif(pvalues, digits = 2), sep = ""),
                                                      "(global test of Trt.)"), collapse = "\n"),
                                              x = grid::unit(1.05, "npc"),
                                              y = grid::unit(0.08, "npc"),
                                              hjust = 0,
                                              gp = grid::gpar(fontsize = 9)))
  } else {
    surv_plots = surv_plots +
      geom_text(data = end_db[end_db$type == "Population / truth",],
                aes(x = time, y = surv_prob, label = round(surv_prob * 100, digits = 0)),
                vjust = -0.3, hjust = 0.8, show.legend = FALSE, size = 3.3) +
      annotation_custom(grob = grid::textGrob(paste(c(paste(perc_sf, " of the sample", sep = ""),
                                                      paste("sets (n) has p < 0.05", sep = ""),
                                                      "(global test of Trt.)"), collapse = "\n"),
                                              x = grid::unit(1.03, "npc"),
                                              y = grid::unit(0.08, "npc"),
                                              hjust = 0,
                                              gp = grid::gpar(fontsize = 9)))
  }

  #Add censoring points
  if(!is.null(sampling_specs))
  {surv_plots = surv_plots + geom_point(data = cens_db, aes(x = time, y = surv_prob, colour = Trt.ID), shape = 3)}

  #Plot theme
  if(theme == "prism") {surv_plots = surv_plots + ggprism::theme_prism()}

  #Save plots and return outputs
  if(!is.null(plot_name)) {
    eoffice::topptx(figure = surv_plots, filename = paste(plot_name, ".pptx", sep = ""), width = 6, height = 4)
    ggsave(paste(plot_name, ".tiff", sep = ""), dpi = 900, width = 6, height = 4, plot = surv_plots)
  }

  if(plot_out == FALSE && pop_out == FALSE) {

    return(simul_surv_db = Surv_simul_outDB)

  } else {

    output = list(simul_surv_db = Surv_simul_outDB)
    if(plot_out == TRUE) {output$surv_plots <- surv_plots}
    if(pop_out == TRUE) {output$population_surv_db <- surv_pop}
    #return(output)
  }
```


Surv_Gen()
```{r}
mort_db = mort_db_ex
starting_fish_count = 100
last_tte = 54
tank_without_mort = NULL
trt_without_mort = NULL
output = "prism"

  #Count the number of rows in mort_db, for each combination of treatment and tank ID
  DB_Mort_Gensum = data.frame(mort_db %>%
                                dplyr::group_by(Trt.ID, Tank.ID) %>%
                                dplyr::summarise(Num_dead = dplyr::n()))

  #Include tanks without morts in the count database
  if(!is.null(tank_without_mort) && !is.null(trt_without_mort)) {
    WM_DB = data.frame(Trt.ID = trt_without_mort,
                       Tank.ID = tank_without_mort,
                       Num_dead = 0)
    DB_Mort_Gensum = rbind(DB_Mort_Gensum, WM_DB)
  }

  #Use tank-specific starting fish count if information provided
  if(is.data.frame(starting_fish_count)) {
    DB_Mort_Gensum = base::merge(DB_Mort_Gensum, starting_fish_count, all.y = TRUE)
    DB_Mort_Gensum$Num_dead[is.na(DB_Mort_Gensum$Num_dead)] = 0
    DB_Mort_Gensum$Num_alive = DB_Mort_Gensum$starting_fish_count - DB_Mort_Gensum$Num_dead
    DB_Mort_Gensum = DB_Mort_Gensum[, -3]
  } else {DB_Mort_Gensum$Num_alive = starting_fish_count - DB_Mort_Gensum$Num_dead}

  #Generate rows of data representing survivors
  DB_Mort_Genalive = data.frame(lapply(DB_Mort_Gensum, rep, DB_Mort_Gensum$Num_alive))
  DB_Mort_Genalive$Status = 0
  DB_Mort_Genalive$TTE = last_tte
  DB_Mort_Gencomb = plyr::rbind.fill(mort_db, DB_Mort_Genalive[, -c(3:4)])
  
  #Create prism output
  if(output == "prism"){
    prism_db = data.frame(blank = rep("", nrow(DB_Mort_Gencomb)))
    
    for(col_nm in trt_levels) {
      temp_db = data.frame(ifelse(DB_Mort_Gencomb$Trt.ID == col_nm, DB_Mort_Gencomb$Status, ""))
      colnames(temp_db) = col_nm
      prism_db = cbind(prism_db, temp_db)
    }
    
    prism_db = cbind(data.frame(DB_Mort_Gencomb[, -which(colnames(DB_Mort_Gencomb) == "Status")]), 
                                prism_db[, -1])
    prism_db = data.frame(prism_db %>% arrange(Trt.ID, Tank.ID))[, -which(colnames(DB_Mort_Gencomb) == "Trt.ID")]
    
    write.csv(prism_db, "Surv_Gen Prism Survival Data.csv")
  }

  return(DB_Mort_Gencomb)
```

