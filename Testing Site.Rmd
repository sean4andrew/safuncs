---
title: "Running Surv_Pred"
output: html_document
date: "`r Sys.Date()`"
---

```{r}
mort_db = mort_db_ex
starting_fish_count = 100
last_tte = 60
add_sampled = data.frame(sampled_TTE = c(30, 40), sampled_per_tank = c(5, 5))
add_factor = NULL
tank_without_mort = NULL
trt_without_mort = NULL
output_prism = FALSE
output_prism_date = NULL

  #Remove NA rows
  mort_db[mort_db == "#N/A"] = NA
  mort_db = na.omit(mort_db)

  groups = append(c("Trt.ID", "Tank.ID"), add_factor)

  #Count the number of rows in mort_db, for each combination of treatment and tank ID
  DB_Mort_Gensum = data.frame(mort_db %>%
                                dplyr::group_by(!!!syms(groups)) %>%
                                dplyr::summarise(Num_dead = dplyr::n(), .groups = "keep"))

  #Include tanks without morts in the count database
  if(!is.null(tank_without_mort) && !is.null(trt_without_mort)) {
    WM_DB = data.frame(Trt.ID = trt_without_mort,
                       Tank.ID = tank_without_mort,
                       Num_dead = 0)
    DB_Mort_Gensum = rbind(DB_Mort_Gensum, WM_DB)
  }

  #Use tank-specific starting fish count if information provided
  if(is.data.frame(starting_fish_count)) {
    DB_Mort_Gensum = base::merge(DB_Mort_Gensum, starting_fish_count, all.y = TRUE)
    DB_Mort_Gensum$Num_dead[is.na(DB_Mort_Gensum$Num_dead)] = 0
    DB_Mort_Gensum$Num_alive = DB_Mort_Gensum$starting_fish_count - DB_Mort_Gensum$Num_dead
    DB_Mort_Gensum = DB_Mort_Gensum[, -c(which(colnames(DB_Mort_Gensum) %in% "starting_fish_count"))]
  } else {DB_Mort_Gensum$Num_alive = starting_fish_count - DB_Mort_Gensum$Num_dead}
  
  #Generate rows of data representing survivors
  DB_Mort_Genalive = data.frame(lapply(DB_Mort_Gensum, rep, DB_Mort_Gensum$Num_alive))
  DB_Mort_Genalive$Status = 0
  DB_Mort_Genalive$TTE = last_tte
  DB_Mort_Gencomb = plyr::rbind.fill(mort_db, DB_Mort_Genalive[, -c(which(colnames(DB_Mort_Gensum)
                                                                          %in% c("Num_alive", "Num_dead")))])
  
  #Transform "survivors" to "sampled" by changing their TTE
  if(is.data.frame(add_sampled)){
    for(ttei in 1:nrow(add_sampled)){
      for(tanki in unique(DB_Mort_Gencomb$Tank.ID)) {
        rowsel = which(DB_Mort_Gencomb$Tank.ID == tanki & DB_Mort_Gencomb$TTE == last_tte)
        rowsel = rowsel[1:add_sampled$sampled_per_tank[ttei]]
        DB_Mort_Gencomb$TTE[rowsel] = add_sampled$sampled_TTE[[ttei]]
      }
    }
  }

  #Create prism output
  if(output_prism == TRUE){

    prism_db = data.frame(blank = rep("", nrow(DB_Mort_Gencomb)))

    #Get treatment specific column entries for Status
    for(col_nm in levels(factor(DB_Mort_Gencomb$Trt.ID))) {
      temp_db = data.frame(ifelse(DB_Mort_Gencomb$Trt.ID == col_nm, DB_Mort_Gencomb$Status, ""))
      colnames(temp_db) = col_nm
      prism_db = cbind(prism_db, temp_db)
    }

    #Organize prism data and save
    if(is.null(output_prism_date)) {
      prism_db = cbind(data.frame(DB_Mort_Gencomb[, -which(colnames(DB_Mort_Gencomb) == "Status")]),
                       prism_db[, -1])
    } else {
      prism_db = cbind(data.frame(starting_date = format(as.Date(output_prism_date, format = "%d-%b-%Y"), "%d-%b-%Y"),
                                  ending_date = format(as.Date(output_prism_date, format = "%d-%b-%Y") + DB_Mort_Gencomb$TTE, "%d-%b-%Y")),
                       data.frame(DB_Mort_Gencomb[, -which(colnames(DB_Mort_Gencomb) == "Status")]),
                       prism_db[, -1])
    }

    prism_db = data.frame(prism_db %>% dplyr::arrange(Trt.ID, Tank.ID))
    write.csv(prism_db, paste("Surv_Gen Prism - last TTE ", last_tte, ".csv", sep = ""))
  }

  print(paste("Your total number of tanks is:", length(unique(factor(DB_Mort_Gencomb$Tank.ID)))))
  print(paste("Your total number of treatment groups is:", length(unique(factor(DB_Mort_Gencomb$Trt.ID)))))
  print(paste("Your total number of fish in the output data is:", nrow(DB_Mort_Gencomb)))
  return(DB_Mort_Gencomb)
```


```{r}
# Starting from an example mortality database, we first generate the complete survivor
# data using Surv_Gen()
data(mort_db_ex)
surv_dat = Surv_Gen(mort_db = mort_db_ex,
                   starting_fish_count = 100,
                   last_tte = 54)

# Create plot by feeding surv_dat to Surv_Plots()!
Surv_Plots(surv_db = surv_dat,
          plot_prefix = "QCATC777",
          xlab = "TTE",
          plot = "both",
          dailybin = FALSE,
          theme = "publication")

# If we want a plot for each tank, we can specify "Tank.ID" as an additional factor:
Tank_Plot = Surv_Plots(surv_db = surv_dat,
                       add_factor = "Tank.ID",
                       plot_prefix = "QCATC777",
                       xlab = "TTE",
                       plot = "surv",
                       dailybin = FALSE,
                       theme = "publication")
Tank_Plot

# The plot can be modified like any ggplot2 object, for example, faceting by treatment:
Tank_Plot + ggplot2::facet_wrap(~ Trt.ID)

# Tank specific hazard curves can also be created. For accurate estimation, the
# parameter phi often has to be specified in low sample size or single tank cases. A
# phi of 1-2 is recommended based on estimates from past data with larger sample sizes.
Surv_Plots(surv_db = surv_dat,
           add_factor = "Tank.ID",
           plot_prefix = "QCATC777",
           phi = 1.5, 
           xlab = "TTE",
           xbreaks = 10,
           plot = "haz",
           dailybin = FALSE,
           theme = "publication") + ggplot2::facet_wrap(~ Trt.ID)
```


```{r}
excel_db = read_xlsx("QCATC1096-3 CRF11 Post Challenge Mortality Record.xlsx")

xlsx_row2coln = function(x) {
  x = data.frame(x)
  colnames(x) = x[1, ]
  x = x[-1, ]
  
  return(x)
}

excel_db2 = xlsx_row2coln(excel_db)

xlsx_trimrow = function(x, coli = 1) {
  colsel = x[, coli]
  x = x[!is.na(colsel), ]
  
  return(x)
}

excel_db3 = xlsx_trimrow(excel_row2colnames(excel_db))

str(excel_db3)
```

```{r}
library(safuncs)
library(dplyr)
library(ggplot2)
setwd("C:/Users/sean4/Downloads")

ref_surv_db = read.csv(file = "QCATC997 Mort.csv")
ref_surv_db2 = ref_surv_db[ref_surv_db$Trt.ID == "E",]
ref_surv_db2$TTE = ref_surv_db2$TTE - 3

pred_mort_DB = read.csv(file = "ONDA01166 Mort.csv")
pred_start_DB = read.csv(file = "ONDA01166 starting_fish_count.csv")

pred_DB = Surv_Gen(mort_db = pred_mort_DB,
                   starting_fish_count = pred_start_DB,
                   last_tte = 38)
```

```{r}
safuncs::Surv_Plots(surv_db = pred_DB,
           x_breaks = 4,
           dailybin = FALSE,
           plot_prefix = "ONDA01166",
           plot_bytank = FALSE,
           plot = "both",
           theme = "prism",
           plot_dim = c(7.2, 4.5),
           colours = c("#007200", "#BABA00", "#FF0000", "#00748E", "#690091", "#4F4F4F"))

# Surv_Plots(surv_db = pred_DB,
#            dailybin = FALSE,
#            plot_bytank = TRUE,
#            phi = 1.5,
#            plot_prefix = "ONDA01166")

a = summary(survival::survfit(survival::Surv(TTE, Status) ~ Tank.ID, data = pred_DB))
(1 - last(a$surv)) * 100

#best is 10,3,1
srs = c(0.213, 0.299, 0.267)
```

```{r}
Surv_Pred(surv_db = pred_DB,
          surv_db_ref = ref_surv_db2,
          pred_tte = 54,
          pred_method = "simple",
          plot_save = TRUE,
          plot_prefix = "ONDA01166")
```

```{r}
data(mort_db_ex)
surv_dat = Surv_Gen(mort_db = mort_db_ex,
                    starting_fish_count = 100,
                    last_tte = 54)

# Create plot by feeding surv_dat to Surv_Plots()!
Surv_Plots(surv_db = surv_dat,
           plot_prefix = "QCATC777",
           xlim = c(0, 56),
           ylim = c(0, 1),
           plot = "surv",
           dailybin = FALSE,
           theme = "publication",
           plot_bytank = TRUE)
```

