---
title: "Running Surv_Pred"
output: html_document
date: "`r Sys.Date()`"
---

```{r}
Surv_Plots = function(surv_db,
                      add_factor = NULL,
                      xlim = NULL,
                      x_breaks = NULL,
                      ylim = c(0, 1),
                      xlab = "Days Post Challenge",
                      lambda = NULL,
                      phi = NULL,
                      dailybin = TRUE,
                      plot = "both",
                      colours = NULL,
                      theme = "ggplot",
                      trt_order = NULL,
                      data_out = FALSE,
                      plot_bytank = FALSE,
                      plot_save = TRUE,
                      plot_prefix = "ONDA_XX",
                      plot_dim = c(6, 4)) {

  if(is.null(xlim)) {xlim <- c(0, max(surv_db$TTE))}
  if(!is.null(trt_order)){surv_db$Trt.ID = factor(surv_db$Trt.ID, levels = trt_order)}
  if(is.null(x_breaks)) {x_breaks <- max(1, round((xlim[2] - xlim[1]) / 10))}
  if(!is.null(add_factor)) {x_breaks <- x_breaks * 2}

  if(plot == "surv" | plot == "both") {

    #Create survfit object
    surv_obj = survminer::surv_fit(as.formula(paste(c("survival::Surv(TTE, Status) ~ Trt.ID", add_factor), collapse = " + ")),
                                   data = surv_db)
    
    #Dealing with one Trt.ID scenario
    if(length(levels(as.factor(surv_db$Trt.ID))) == 1) {
      strn = unique(surv_db$Trt.ID)
    } else {
      
      #Add strata names
      strn = attributes(surv_obj$strata)$names
      if(is.null(add_factor)){
        strn = sub(".*=", "", strn)
      } else {
        strn = gsub(".*=(.*),.*=(.*)", "\\1, \\2", strn)
      }
      strn = sub("\\s+$", "", strn) 
    }

    #Create survival plot
    surv_plot = survminer::ggsurvplot(surv_obj,
                                      conf.int = FALSE,
                                      ggtheme = theme(plot.background = element_rect(fill = "white")),
                                      surv.scale = "percent",
                                      xlim = xlim,
                                      ylim = ylim,
                                      short.panel.labs = TRUE,
                                      short.legend.labs = TRUE)$plot
    if(is.null(colours)) {color_vec <- unique(layer_data(surv_plot)[,1])} else {color_vec = colours}
    surv_plot$scales$scales = list()
    surv_plot = surv_plot + 
      guides(color = guide_legend(paste(c("Trt.ID", add_factor), collapse = ", "))) + 
      theme(legend.position = "right") + 
      scale_x_continuous(breaks = seq(0, xlim[2] + 100, x_breaks), name = xlab, limits = xlim, oob = scales::squish) +
      scale_y_continuous(labels = scales::percent, limits = ylim, n.breaks = 10) +
      scale_color_manual(labels = strn, values = color_vec) 
    
    #Create survdat
    surv_dat = data.frame(Trt.ID = surv_plot$data$strata,
                          Survprob = surv_plot$data$surv,
                          Time = surv_plot$data$time)
    
    #Address names
    if(!is.null(add_factor)){
      surv_dat$Trt.ID = gsub(".*=(.*),.*=(.*)", "\\1, \\2", surv_dat$Trt.ID)
      surv_dat = tidyr::separate(data = surv_dat, col = "Trt.ID", sep = ", ", into = c("Trt.ID", add_factor))
    }
    
    #Add theme
    Survival_Plot = surv_plot
    if(theme == "prism") {Survival_Plot <- Survival_Plot + ggprism::theme_prism()}
    if(theme == "publication") {Survival_Plot <- Survival_Plot + safuncs::theme_Publication()}

    #Save Plots
    if(plot_save == TRUE){
      ggsave(paste(plot_prefix, "Survival-Curve.tiff", sep = "-"), dpi = 300,
             width = plot_dim[1], height = plot_dim[2], plot = Survival_Plot)
      eoffice::topptx(figure = Survival_Plot, width = plot_dim[1], height = plot_dim[2],
                      filename = paste(plot_prefix, "Survival-Curve.pptx", sep = "-"))
    }
  }

  #Dealing with hazard curve creation
  if(dailybin == TRUE) {dbin <- max(surv_db$TTE)}
  if(dailybin == FALSE) {dbin <- NULL}

  #create Haz_list
  if(plot == "haz" | plot == "both") {
    Haz_list = list()

    if(!is.null(add_factor)) {
      surv_db$group = factor(interaction(surv_db$Trt.ID, surv_db[, add_factor], sep = ", "), levels = strn)
    } else {
      surv_db$group = factor(surv_db$Trt.ID)
    }
    Haz_Group_Vec = unique(surv_db$group)

    #Create haz curve for each group
    for(Haz_Group in Haz_Group_Vec) {
      
      #Filter data for a group
      surv_db_group = droplevels(surv_db[surv_db$group == Haz_Group,])

      #Address no mort situations
      if(sum(surv_db_group$Status) == 0){
        Haz_list[[Haz_Group]] = data.frame(Hazard = 0,
                                           Time = rep(0, max(surv_db$TTE), 1))
      } else { #Create haz curves
        sink(tempfile())
        if(length(levels(as.factor(surv_db_group$Tank.ID))) > 1) {iv <- "Tank.ID"} else {iv <- 1}
        Haz_bs = bshazard::bshazard(nbin = dbin,
                                    data = surv_db_group,
                                    formula = as.formula(paste("survival::Surv(TTE, Status) ~", iv)),
                                    verbose = FALSE,
                                    lambda = lambda,
                                    phi = phi)
        sink()
        Haz_list[[Haz_Group]] = data.frame(Hazard = Haz_bs$hazard,
                                           Time = Haz_bs$time)
      }
    }

    #Create hazard database
    haz_db = dplyr::bind_rows(Haz_list, .id = paste(c("Trt.ID", add_factor), collapse = ", "))
    if(!is.null(add_factor)){
      haz_db = tidyr::separate(data = haz_db, col = 1, into = c("Trt.ID", add_factor), sep = ", ", remove = FALSE)
    }
    if(!is.null(trt_order)){haz_db$Trt.ID <- factor(haz_db$Trt.ID, levels = trt_order)}

    #Create hazard plot
    Hazard_Plot = ggplot(data = haz_db, 
                         aes(x = Time, y = Hazard, color = .data[[paste(c("Trt.ID", add_factor), collapse = ", ")]])) +
      geom_line(linewidth = 1) +
      geom_point() +
      scale_x_continuous(breaks = seq(0, xlim[2] + 100, x_breaks),
                         limits = xlim, name = xlab) +
      scale_y_continuous(n.breaks = 6, name = "Hazard Rate")

    if(!is.null(colours)) {Hazard_Plot <- Hazard_Plot + scale_color_manual(values = colours)}
    if(theme == "prism") {Hazard_Plot <- Hazard_Plot + ggprism::theme_prism()}
    if(theme == "publication") {Hazard_Plot <- Hazard_Plot + safuncs::theme_Publication()}

    #Save plots
    if(plot_save == TRUE) {
      ggsave(paste(plot_prefix, "Hazard-Curve.tiff", sep = "-"), dpi = 300,
             width = plot_dim[1], height = plot_dim[2], plot = Hazard_Plot)
      eoffice::topptx(figure = Hazard_Plot, filename = paste(plot_prefix, "Hazard-Curve.pptx", sep = "-"),
                      width = plot_dim[1], height = plot_dim[2])
    }
  }

  #Print outputs
  if(data_out == TRUE) {
    if(plot == "surv") {return(list(Survival_Plot = Survival_Plot, Survival_DB = surv_dat))}
    if(plot == "haz") {return(list(Hazard_Plot = Hazard_Plot, Hazard_DB = haz_db))}
    if(plot == "both") {return(list(Survival_Plot = Survival_Plot, Survival_DB = surv_dat, 
                                    Hazard_Plot = Hazard_Plot, Hazard_DB = haz_db))}
  } else {
    if(plot == "surv") {return(Survival_Plot = Survival_Plot)}
    if(plot == "haz") {return(Hazard_Plot = Hazard_Plot)}
    if(plot == "both") {return(list(Survival_Plot = Survival_Plot, Hazard_Plot = Hazard_Plot))}
  }
}
```

```{r}
# Starting from an example mortality database, we first generate the complete survivor
# data using Surv_Gen()
data(mort_db_ex)
surv_dat = Surv_Gen(mort_db = mort_db_ex,
                   starting_fish_count = 100,
                   last_tte = 54)

# Create plot by feeding surv_dat to Surv_Plots()!
Surv_Plots(surv_db = surv_dat,
          plot_prefix = "QCATC777",
          xlab = "TTE",
          plot = "both",
          dailybin = FALSE,
          theme = "publication")

# If we want a plot for each tank, we can specify "Tank.ID" as an additional factor:
Tank_Plot = Surv_Plots(surv_db = surv_dat,
                       add_factor = "Tank.ID",
                       plot_prefix = "QCATC777",
                       xlab = "TTE",
                       plot = "surv",
                       dailybin = FALSE,
                       theme = "publication")
Tank_Plot

# The plot can be modified like any ggplot2 object, for example, faceting by treatment:
Tank_Plot + ggplot2::facet_wrap(~ Trt.ID)

# Tank specific hazard curves can also be created. For accurate estimation, the
# parameter phi often has to be specified in low sample size or single tank cases. A
# phi of 1-2 is recommended based on estimates from past data with larger sample sizes.
Surv_Plots(surv_db = surv_dat,
           add_factor = "Tank.ID",
           plot_prefix = "QCATC777",
           phi = 1.5, 
           xlab = "TTE",
           xbreaks = 10,
           plot = "haz",
           dailybin = FALSE,
           theme = "publication") + ggplot2::facet_wrap(~ Trt.ID)
```




```{r Surv Pred}
surv_db
surv_db_ref
pred_tte = NULL 
pred_method = "simple"
pred_dailybin = TRUE
pred_phi = 1.5
pred_lambda = NULL
plot_save = TRUE
plot_prefix = "ONDA_XX"
data_out = TRUE

 #Set 0 offset time
 ref_TTE0 = surv_db_ref$TTE

 #Default pred_tte
 if(is.null(pred_tte)) {pred_tte <- max(ref_TTE0)}

 #Initialize dataframes
 Pred_Stats = data.frame()
 Pred_Stats_Offset = data.frame()

 #Determine experimental design
 if(length(unique(surv_db_ref$Trt.ID)) > 1) {
   stop("surv_db_ref must contain only one Trt.ID.")
 }

 exp_design = ifelse((length(unique(surv_db$Trt.ID)) == length(unique(surv_db$Tank.ID))) &
                       (length(unique(surv_db_ref$Trt.ID)) == length(unique(surv_db_ref$Tank.ID))),
                       "single_tank", "multi-tank")

 #Set parameters for ref_bshaz estimation
 if(exp_design == "single-tank") {
   if(pred_dailybin == TRUE) {dbin <- max(surv_db_ref$TTE)} else {dbin <- NULL}
 } else {
   pred_phi = NULL
   pred_lambda = NULL
   pred_dailybin = FALSE
   dbin = NULL
 }

 #Get reference level hazard curve
 ref_id = levels(as.factor(surv_db_ref$Trt.ID))
 surv_db_ref$Trt.ID = paste("ref", ref_id)

 sink(tempfile())
 if(exp_design == "single-tank"){
   ref_bshaz = bshazard::bshazard(data = surv_db_ref, survival::Surv(TTE, Status) ~ 1,
                                  verbose = FALSE, phi = pred_phi, lambda = pred_lambda,
                                  nbin = dbin)
 } else {
   ref_bshaz = bshazard::bshazard(data = surv_db_ref, survival::Surv(TTE, Status) ~ Tank.ID,
                                  verbose = FALSE, phi = pred_phi, lambda = pred_lambda,
                                  nbin = dbin)
 }
 sink()

 #Produce offset times
 show_offset = TRUE
 if(show_offset == TRUE) {ref_tte_offset_vec <- c(-1, 0, 1) * 2} else {ref_tte_offset_vec <- 0}

 #Repeat for different offset times
 for(ref_tte_offset in ref_tte_offset_vec) {

   #Ensure positive TTE
   surv_db = surv_db[surv_db$TTE > 0, ]
   surv_db_ref$TTE = ref_TTE0 + ref_tte_offset
   surv_db_ref = surv_db_ref[surv_db_ref$TTE > 0, ]

   #Print warning message if surv_db_ref end TTE < pred_tte
   if(max(surv_db_ref$TTE) < pred_tte) {
     warning(paste(sep = "", "The desired 'pred_tte' (", pred_tte,
                   ") is greater than the maximum in the reference database (",
                   max(surv_db_ref$TTE) ,") given the TTE offset of ", ref_tte_offset,
                   ". For this offset, predictions are for 'pred_tte' ", ref_tte_offset,
                   " (i.e. TTE = ", max(surv_db_ref$TTE),")."))
   }

   #Loop for every treatment
   for(pred_trt in levels(as.factor(surv_db$Trt.ID))) {

     #Combine reference and observed hazard dataframes
     surv_db_f = surv_db[surv_db$Trt.ID == pred_trt,]
     comb_db = rbind(surv_db_ref, surv_db_f)
     comb_db$Trt.ID = relevel(as.factor(comb_db$Trt.ID), ref = paste("ref", ref_id))

     min2_tte = max(min(surv_db_f$TTE), min(surv_db_ref$TTE))
     max_tte = max(surv_db_f$TTE)

     #Predict End SR and HR using different cuts
     for(cut_day in min2_tte:max_tte) {
       comb_db2 = survival::survSplit(comb_db, cut = cut_day, end = "TTE", event = "Status", episode = "Obs")
       comb_db2 = comb_db2[comb_db2$Obs == 1, ]

       #HR Calculation
       cox_comp = suppressWarnings(coxme::coxme(survival::Surv(TTE, Status) ~ Trt.ID + (1|Tank.ID),
                                                data = comb_db2))
       pred_HR = exp(coef(cox_comp))

       #SR Calculation
       ref_bshaz_t = data.frame(hazard = ref_bshaz$hazard[ref_bshaz$time < pred_tte],
                                time = ref_bshaz$time[ref_bshaz$time < pred_tte])

       #Uses the shape of the reference hazard curve throughout
       if(pred_method == "simple") {
         cumhaz = DescTools::AUC(x = c(ref_bshaz_t$time),
                                 y = c(ref_bshaz_t$hazard) * pred_HR)
         pred_SR = 100 * exp(-cumhaz)
       }

       #Uses obseved survival and the reference hazard curve
       if(pred_method == "adaptive") {

         #Split survival data for calculating cumulative hazard using the reference and the observable hazard curve
         cut_db = survival::survSplit(surv_db, cut = cut_day + 1, end = "TTE", event = "Status", episode = "Obs")
         precut_db = cut_db[cut_db$Obs == 1, ]

         #Precut surv using surv_db
         precut_surv = min(summary(survival::survfit(survival::Surv(TTE, Status) ~ 1,
                                           data = droplevels(precut_db[precut_db$Trt.ID == pred_trt,])))$surv)
         cumhaz_precut = -log(precut_surv)

         #Postcut bshaz using surv_db_ref
         postcut_bshaz = ref_bshaz_t[ref_bshaz_t$time > cut_day,]
         if(nrow(postcut_bshaz) > 1) {
           cumhaz_postcut = DescTools::AUC(x = c(postcut_bshaz$time),
                                           y = c(postcut_bshaz$hazard) * pred_HR)
         } else {
           cumhaz_postcut = 0
         }

         if(is.na(cumhaz_postcut)) {cumhaz_postcut <- 0}
         pred_SR = 100 * exp(-(cumhaz_precut + cumhaz_postcut))
       }

       #Rbind to create prediction database
       if(ref_tte_offset == 0) {
         Pred_Stats = rbind(Pred_Stats, data.frame(Trt.ID = pred_trt,
                                                   TTE_Used = cut_day,
                                                   pred_SR,
                                                   pred_HR))
       } else {
         Pred_Stats_Offset = rbind(Pred_Stats_Offset, data.frame(ref_tte_offset,
                                                                 Trt.ID = pred_trt,
                                                                 TTE_Used = cut_day,
                                                                 pred_SR,
                                                                 pred_HR))
       }
     }
   }
 }

 row.names(Pred_Stats) = NULL
 row.names(Pred_Stats_Offset) = NULL

 #Create plots representing survival and hazard predictions over time
 x_breaks = round((max(Pred_Stats$TTE_Used) - min(Pred_Stats$TTE_Used)) / 5)

 Pred_SR_Plot = ggplot(data = Pred_Stats, aes(x = TTE_Used, y = pred_SR, color = Trt.ID)) +
   geom_point() +
   geom_line() +
   facet_wrap(~Trt.ID) +
   scale_y_continuous(name = paste("Predicted SR at a TTE of", pred_tte),
                      breaks = seq(0, 100, 20), limits = c(0, 100)) +
   scale_x_continuous(name = "TTEs used to predict", breaks = seq(0, 100, x_breaks)) +
   ggtitle("SR Prediction History")

 Pred_HR_Plot = ggplot(data = Pred_Stats, aes(x = TTE_Used, y = pred_HR, color = Trt.ID)) +
   geom_point() +
   geom_line() +
   facet_wrap(~Trt.ID) +
   scale_y_continuous(name = paste("Predicted HR at a TTE of", pred_tte), n.breaks = 6) +
   scale_x_continuous(name = "TTEs used to predict", breaks = seq(0, 100, x_breaks)) +
   ggtitle("HR Prediction History")

 if(show_offset == TRUE){
   Pred_SR_Plot = Pred_SR_Plot +
     geom_line(data = Pred_Stats_Offset[Pred_Stats_Offset$ref_tte_offset == ref_tte_offset_vec[1],],
               linetype = "dashed", show.legend = FALSE) +
     geom_line(data = Pred_Stats_Offset[Pred_Stats_Offset$ref_tte_offset == ref_tte_offset_vec[3],],
               linetype = "dashed", show.legend = FALSE)

   Pred_HR_Plot = Pred_HR_Plot +
     geom_line(data = Pred_Stats_Offset[Pred_Stats_Offset$ref_tte_offset == ref_tte_offset_vec[1],],
               linetype = "dashed", show.legend = FALSE) +
     geom_line(data = Pred_Stats_Offset[Pred_Stats_Offset$ref_tte_offset == ref_tte_offset_vec[3],],
               linetype = "dashed", show.legend = FALSE)
 }

 #Create Projection Plots
 surv_db_ref$TTE = ref_TTE0
 ref_plot_db = layer_data(Surv_Plots(surv_db = surv_db_ref,
                                     plot = "surv",
                                     plot_save = FALSE))
 ref_plot_db2 = layer_data(Surv_Plots(surv_db = surv_db_ref,
                                      plot = "haz",
                                      lambda = pred_lambda,
                                      phi = pred_phi,
                                      dailybin = pred_dailybin,
                                      plot_save = FALSE))

 Comp_SR_Plot = Surv_Plots(surv_db = surv_db,
                           plot = "surv",
                           xlim = c(0, pred_tte),
                           plot_save = FALSE) +
     geom_step(data = ref_plot_db, inherit.aes = FALSE, show.legend = FALSE,
             aes(x = x, y = y), linewidth = 1) +
   ggtitle("Survival Rate Comparisons")

 Comp_HR_Plot = Surv_Plots(surv_db = surv_db,
                           plot = "haz",
                           xlim = c(0, pred_tte),
                           lambda = pred_lambda,
                           phi = pred_phi,
                           dailybin = pred_dailybin,
                           plot_save = FALSE) +
   geom_line(data = ref_plot_db2, inherit.aes = FALSE, show.legend = FALSE, aes(x = x, y = y),
             linewidth = 1) +
   ggtitle("Hazard Rate Comparisons")

 #Save plots
 if(plot_save == TRUE) {
   ggsave(plot = Pred_SR_Plot, filename = paste(sep = "", plot_prefix, " SR Prediction History.tiff"),
          dpi = 400, width = 7, height = 4.1)
   ggsave(plot = Pred_HR_Plot, filename = paste(sep = "", plot_prefix, " HR Prediction History.tiff"),
          dpi = 400, width = 7, height = 4.1)
   ggsave(plot = Comp_SR_Plot, dpi = 400, width = 6, height = 4,
          filename = paste(sep = "", plot_prefix, " Survival Comparisons.tiff"))
   ggsave(plot = Comp_HR_Plot, dpi = 400, width = 6, height = 4,
          filename = paste(sep = "", plot_prefix, " Hazard Comparisons.tiff"))
 }

 #Return Outputs
 Output_list = list(Comp_SR_Plot = Comp_SR_Plot,
                    Comp_HR_Plot = Comp_HR_Plot,
                    Pred_SR_Plot = Pred_SR_Plot,
                    Pred_HR_Plot = Pred_HR_Plot)

 if(data_out == TRUE) {
   Output_list = append(Output_list,
                        list(Pred_TTE = Pred_Stats[Pred_Stats$TTE_Used == max(Pred_Stats$TTE_Used),
                                                   -which(colnames(Pred_Stats) == "TTE_Used")],
                             Pred_History = Pred_Stats))
 }
 return(Output_list)
```


















```{r}
excel_db = read_xlsx("QCATC1096-3 CRF11 Post Challenge Mortality Record.xlsx")

xlsx_row2coln = function(x) {
  x = data.frame(x)
  colnames(x) = x[1, ]
  x = x[-1, ]
  
  return(x)
}

excel_db2 = xlsx_row2coln(excel_db)

xlsx_trimrow = function(x, coli = 1) {
  colsel = x[, coli]
  x = x[!is.na(colsel), ]
  
  return(x)
}

excel_db3 = xlsx_trimrow(excel_row2colnames(excel_db))

str(excel_db3)
```

```{r}
library(safuncs)
library(dplyr)
library(ggplot2)
setwd("C:/Users/sean4/Downloads")

ref_surv_db = read.csv(file = "QCATC997 Mort.csv")
ref_surv_db2 = ref_surv_db[ref_surv_db$Trt.ID == "E",]
ref_surv_db2$TTE = ref_surv_db2$TTE - 3

pred_mort_DB = read.csv(file = "ONDA01166 Mort.csv")
pred_start_DB = read.csv(file = "ONDA01166 starting_fish_count.csv")

pred_DB = Surv_Gen(mort_db = pred_mort_DB,
                   starting_fish_count = pred_start_DB,
                   last_tte = 38)
```

```{r}
safuncs::Surv_Plots(surv_db = pred_DB,
           x_breaks = 4,
           dailybin = FALSE,
           plot_prefix = "ONDA01166",
           plot_bytank = FALSE,
           plot = "both",
           theme = "prism",
           plot_dim = c(7.2, 4.5),
           colours = c("#007200", "#BABA00", "#FF0000", "#00748E", "#690091", "#4F4F4F"))

# Surv_Plots(surv_db = pred_DB,
#            dailybin = FALSE,
#            plot_bytank = TRUE,
#            phi = 1.5,
#            plot_prefix = "ONDA01166")

a = summary(survival::survfit(survival::Surv(TTE, Status) ~ Tank.ID, data = pred_DB))
(1 - last(a$surv)) * 100

#best is 10,3,1
srs = c(0.213, 0.299, 0.267)
```

```{r}
Surv_Pred(surv_db = pred_DB,
          surv_db_ref = ref_surv_db2,
          pred_tte = 54,
          pred_method = "simple",
          plot_save = TRUE,
          plot_prefix = "ONDA01166")
```

```{r}
data(mort_db_ex)
surv_dat = Surv_Gen(mort_db = mort_db_ex,
                    starting_fish_count = 100,
                    last_tte = 54)

# Create plot by feeding surv_dat to Surv_Plots()!
Surv_Plots(surv_db = surv_dat,
           plot_prefix = "QCATC777",
           xlim = c(0, 56),
           ylim = c(0, 1),
           plot = "surv",
           dailybin = FALSE,
           theme = "publication",
           plot_bytank = TRUE)
```

